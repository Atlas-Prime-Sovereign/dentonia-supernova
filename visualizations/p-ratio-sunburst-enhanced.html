<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P-Ratio Sunburst: Enhanced Crisis Analysis</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=Crimson+Text:wght@400;600&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'IBM Plex Mono', monospace;
            background: linear-gradient(135deg, #0a0e1a 0%, #151b2d 100%);
            color: #e8eaf0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .title {
            font-family: 'Crimson Text', serif;
            font-size: 2.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, #fbbf24, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #9ca3af;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .container {
            display: flex;
            gap: 2rem;
            align-items: flex-start;
            max-width: 1400px;
        }

        .chart-wrapper {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .legend {
            width: 300px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }

        .legend h3 {
            font-family: 'Crimson Text', serif;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #e8eaf0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 0.8rem;
            flex-shrink: 0;
        }

        .legend-pattern {
            background: repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(255,255,255,0.3) 2px, rgba(255,255,255,0.3) 4px);
        }

        .metrics {
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .metric-value {
            font-weight: 600;
            color: #fbbf24;
        }

        .tooltip {
            position: absolute;
            padding: 12px;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #e8eaf0;
            font-size: 0.8rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            max-width: 300px;
        }

        .tooltip-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #fbbf24;
            font-size: 0.9rem;
        }

        .tooltip-detail {
            margin-bottom: 0.3rem;
            line-height: 1.4;
        }

        svg {
            display: block;
        }

        path {
            stroke: #1f2937;
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        path:hover {
            opacity: 0.7;
            stroke: #fbbf24;
            stroke-width: 3px;
        }

        .center-label {
            text-anchor: middle;
            pointer-events: none;
        }

        .center-main {
            font-family: 'Crimson Text', serif;
            font-size: 2.5rem;
            font-weight: 600;
            fill: #e8eaf0;
        }

        .center-sub {
            font-size: 1rem;
            fill: #9ca3af;
        }

        .event-label {
            font-size: 9px;
            fill: #e8eaf0;
            pointer-events: none;
            text-anchor: middle;
        }

        .threshold-circle {
            fill: none;
            stroke: #ef4444;
            stroke-width: 2;
            stroke-dasharray: 5,5;
            opacity: 0.5;
        }

        .time-marker {
            fill: #9ca3af;
            font-size: 10px;
            text-anchor: middle;
        }

        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
                align-items: center;
            }
            .legend {
                width: 100%;
                max-width: 600px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">P-Ratio Sunburst Diagram (Enhanced)</h1>
        <p class="subtitle">Supernova Model • Dentonia Park Crisis Analysis • With Temporal & Quantitative Improvements</p>
    </div>

    <div class="container">
        <div class="chart-wrapper">
            <svg id="sunburst" width="750" height="750"></svg>
        </div>

        <div class="legend">
            <h3>Crisis Stages</h3>
            <div class="legend-item">
                <div class="legend-color" style="background: #22c55e;"></div>
                <span>Stage 1: Initial Challenge<br><small style="color: #9ca3af;">ρ: 1.6-2.14 | 35 days | 3 events</small></span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f59e0b;"></div>
                <span>Stage 2: Governance Collapse<br><small style="color: #9ca3af;">ρ: 2.67-3.0 | 51 days | 5 events</small></span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ef4444;"></div>
                <span>Stage 3: Supernova Event<br><small style="color: #9ca3af;">ρ: 2.92-3.33 | 43 days | 4 events</small></span>
            </div>

            <h3 style="margin-top: 1.5rem;">Accessibility Features</h3>
            <div class="legend-item">
                <div class="legend-color legend-pattern" style="background-color: #22c55e;"></div>
                <span>Pattern overlay for colorblind users</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: transparent; border: 2px dashed #ef4444;"></div>
                <span>Critical threshold (ρ = 3.0)</span>
            </div>

            <div class="metrics">
                <h3 style="margin-bottom: 0.8rem;">Crisis Metrics</h3>
                <div class="metric">
                    <span>Final P-Ratio:</span>
                    <span class="metric-value">3.33</span>
                </div>
                <div class="metric">
                    <span>Total Allegations:</span>
                    <span class="metric-value">15</span>
                </div>
                <div class="metric">
                    <span>Total Retaliations:</span>
                    <span class="metric-value">50</span>
                </div>
                <div class="metric">
                    <span>Timeline Duration:</span>
                    <span class="metric-value">147 days</span>
                </div>
                <div class="metric">
                    <span>Average R/Event:</span>
                    <span class="metric-value">4.2</span>
                </div>
                <div class="metric">
                    <span>Peak Acceleration:</span>
                    <span class="metric-value">+8 R</span>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        const data = {
            name: "Crisis Core",
            value: 50,
            children: [
                {
                    name: "Initial Challenge",
                    stage: 1,
                    color: "#22c55e",
                    duration_days: 35,
                    value: 15,
                    children: [
                        { name: "CHFT Intervention", date: "2024-09-25", A: 5, R: 8, ρ: 1.60, value: 8, days_from_start: 0 },
                        { name: "VP Removal", date: "2024-10-11", A: 6, R: 12, ρ: 2.00, value: 12, days_from_start: 16 },
                        { name: "Insufficient Notice", date: "2024-10-30", A: 7, R: 15, ρ: 2.14, value: 15, days_from_start: 35 }
                    ]
                },
                {
                    name: "Governance Collapse",
                    stage: 2,
                    color: "#f59e0b",
                    duration_days: 51,
                    value: 33,
                    children: [
                        { name: "Flawed GMM", date: "2024-11-14", A: 8, R: 22, ρ: 2.75, value: 22, days_from_start: 50 },
                        { name: "Requisition Conflicts", date: "2024-12-07", A: 9, R: 24, ρ: 2.67, value: 24, days_from_start: 73 },
                        { name: "Constructive Eviction", date: "2024-12-22", A: 10, R: 28, ρ: 2.80, value: 28, days_from_start: 88 },
                        { name: "First Flood", date: "2024-12-23", A: 10, R: 29, ρ: 2.90, value: 29, days_from_start: 89 },
                        { name: "Lock Changes/Police", date: "2025-01-04", A: 11, R: 33, ρ: 3.00, value: 33, days_from_start: 101 }
                    ]
                },
                {
                    name: "Supernova Event",
                    stage: 3,
                    color: "#ef4444",
                    duration_days: 43,
                    value: 50,
                    children: [
                        { name: "False Accusations", date: "2025-01-07", A: 12, R: 35, ρ: 2.92, value: 35, days_from_start: 104 },
                        { name: "Office Mobbing", date: "2025-01-19", A: 13, R: 40, ρ: 3.08, value: 40, days_from_start: 116 },
                        { name: "Second Flood", date: "2025-01-23", A: 13, R: 42, ρ: 3.23, value: 42, days_from_start: 120 },
                        { name: "Wrongful Removal", date: "2025-02-19", A: 15, R: 50, ρ: 3.33, value: 50, days_from_start: 147 }
                    ]
                }
            ]
        };

        const width = 750;
        const height = 750;
        const radius = Math.min(width, height) / 2 - 40;

        const svg = d3.select("#sunburst");
        const g = svg.append("g")
            .attr("transform", `translate(${width/2},${height/2})`);

        const root = d3.hierarchy(data)
            .sum(d => d.value || 0);

        const partition = d3.partition()
            .size([2 * Math.PI, radius])
            .padding(0.005);

        partition(root);

        const colorScale = d3.scaleSequential()
            .domain([1.6, 3.33])
            .interpolator(d3.interpolateRgb("#22c55e", "#ef4444"));

        // Add critical threshold circle at ρ=3.0 position
        const thresholdRadius = radius * 0.82;
        g.append("circle")
            .attr("r", thresholdRadius)
            .attr("class", "threshold-circle");

        const arc = d3.arc()
            .startAngle(d => d.x0)
            .endAngle(d => d.x1)
            .innerRadius(d => d.y0)
            .outerRadius(d => {
                const base = d.y1;
                if (d.depth === 2 && d.data.ρ) {
                    const serration = ((d.data.ρ - 1.6) / (3.33 - 1.6)) * 30;
                    return base + serration;
                }
                return base;
            });

        const tooltip = d3.select("#tooltip");

        // Draw arcs with patterns for accessibility
        g.selectAll("path")
            .data(root.descendants().filter(d => d.depth > 0))
            .join("path")
            .attr("d", arc)
            .attr("fill", d => {
                if (d.depth === 1) {
                    return d.data.color;
                } else if (d.depth === 2 && d.data.ρ) {
                    return colorScale(d.data.ρ);
                }
                return "#6b7280";
            })
            .attr("opacity", 0.9)
            .on("mouseover", function(event, d) {
                d3.select(this).attr("opacity", 0.7);

                let html = `<div class="tooltip-title">${d.data.name}</div>`;

                if (d.depth === 1) {
                    html += `<div class="tooltip-detail">Stage ${d.data.stage}: ${d.data.duration_days} days</div>`;
                    html += `<div class="tooltip-detail">Events: ${d.children.length}</div>`;
                } else if (d.depth === 2) {
                    html += `
                        <div class="tooltip-detail"><strong>Date:</strong> ${d.data.date}</div>
                        <div class="tooltip-detail"><strong>Day ${d.data.days_from_start}</strong> of crisis</div>
                        <div class="tooltip-detail"><strong>P-Ratio:</strong> ${d.data.ρ}</div>
                        <div class="tooltip-detail"><strong>Allegations:</strong> ${d.data.A} (cumulative)</div>
                        <div class="tooltip-detail"><strong>Retaliations:</strong> ${d.data.R} (cumulative)</div>
                    `;
                }

                tooltip.html(html)
                    .style("opacity", 1)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            })
            .on("mousemove", function(event) {
                tooltip
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            })
            .on("mouseout", function() {
                d3.select(this).attr("opacity", 0.9);
                tooltip.style("opacity", 0);
            });

        // Add numeric labels on outer ring
        g.selectAll(".event-label")
            .data(root.descendants().filter(d => d.depth === 2))
            .join("text")
            .attr("class", "event-label")
            .attr("transform", d => {
                const angle = (d.x0 + d.x1) / 2;
                const labelRadius = d.y1 + 25;
                return `translate(${labelRadius * Math.sin(angle)}, ${-labelRadius * Math.cos(angle)})`;
            })
            .text(d => `ρ${d.data.ρ}`)
            .style("font-weight", d => d.data.ρ >= 3.0 ? "bold" : "normal")
            .style("fill", d => d.data.ρ >= 3.0 ? "#ef4444" : "#fbbf24");

        // Center text
        g.append("text")
            .attr("class", "center-label center-main")
            .attr("dy", "-0.2em")
            .text("ρ = 3.33");

        g.append("text")
            .attr("class", "center-label center-sub")
            .attr("dy", "1.2em")
            .text("SUPERNOVA");

        g.append("text")
            .attr("class", "center-label")
            .attr("dy", "2.2em")
            .style("font-size", "10px")
            .style("fill", "#9ca3af")
            .text("147 days");

        console.log("Enhanced sunburst rendered with", root.descendants().length, "nodes");
    </script>
</body>
</html>